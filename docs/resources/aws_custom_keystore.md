---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "ciphertrust_aws_custom_keystore Resource - terraform-provider-ciphertrust"
subcategory: ""
description: |-
  
---

# ciphertrust_aws_custom_keystore (Resource)

A custom key store is a logical key store within AWS KMS that is backed by a key manager outside of AWS KMS that customer own and manage.  

AWS KMS supports two types of custom key stores - EXTERNAL_KEY_STORE, AWS_CLOUDHSM.  
An external key store is a custom key store backed by an external key manager that customer owns and manages outside of AWS.  
An AWS CloudHSM key store is an custom key store backed by an AWS CloudHSM cluster.

Primary uses of the ciphertrust_aws_custom_keystore resource include:
- Creating a AWS custom keystore of following types - EXTERNAL_KEY_STORE or AWS_CLOUDHSM
- Keystore of EXTERNAL_KEY_STORE can be backed by Luna as key source or Ciphertrust Manager as key source
- Updating an existing AWS custom keystore
- Perform following operations on a custom keystore of type EXTERNAL_KEY_STORE:
  - block/unblock
  - link an unlinked keystore
  - connect/disconnect 
- Perform following operations on a custom keystore of type AWS_CLOUDHSM:
  - connect/disconnect

## Prerequisites
### External Key Store
- External Key Store can be in either linked or Unlinked state. Linked keystore is automatically created in AWS too. 
- Following resources are required to exist before creating EXTERNAL_KEY_STORE:
  - AWS connection on CM ([ciphertrust_aws_connection](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/aws_connection) resource)
  - AWS KMS account on CM ([ciphertrust_aws_kms](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/aws_kms) resource)
- External Key Store can be exposed as VPC Endpoint Service in customer's VPC in AWS or as publicly routable endpoint. 
  See schema for details on required parameters for both options.  

- External Key Store can be in either linked or Unlinked state. Linked keystore is automatically created in AWS too.  

- Creation of AWS HYOK key is supported for locally hosted External Key Store. 
- AWS HYOK key source tier and External Key Store key source tier need to match. Following key sources are supported:
    - Luna as key source
    - Ciphertrust Manager as key source

- For creating External Key Store with Luna as key source, following needs to be configured:
    - Luna HSM connection on CM ([ciphertrust_hsm_connection](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/hsm_connection) resource)
    - Luna HSM server setup on CM ([ciphertrust_hsm_server](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/hsm_server) resource)
    - Luna Partition ([ciphertrust_hsm_partition](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/hsm_partition) resource)
    - Symmetric AES-256 Luna key ([ciphertrust_hsm_key](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/hsm_key) resource)

- For creating External Key Store with Ciphertrust Manager as key source, following needs to be configured:
    - Symmetric AES-256 CM key ([ciphertrust_cm_key](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/cm_key) resource)  


### CloudHSM Key Store
- Following resources are required to exist before creating AWS_CLOUDHSM Key Store:
    - AWS connection on CM  ([ciphertrust_aws_connection](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/aws_connection) resource)
    - AWS KMS account on CM ([ciphertrust_aws_kms](https://registry.terraform.io/providers/ThalesGroup/ciphertrust/latest/docs/resources/aws_kms) resource)
    - CloudHSM cluster setup on AWS (refer AWS CloudHSM documentation including the AWS Key Management Service Developer Guide and AWS CloudHSM User Guide.)
- Connect operation on CloudHSM key store can take upto 30 minutes in AWS
- Disconnect operation on CloudHSM key store can take upto 10 minutes in AWS

## Destroying AWS Custom Key Store

- Custom key store can be deleted only after deleting keys in it. This applies to both types of key stores - EXTERNAL_KEY_STORE, AWS_CLOUDHSM.
- For key in AWS, key can be scheduled to be deleted between 7-30 days.

## Example Usage
- Below are the examples of EXTERNAL_KEY_STORE (unlinked and linked) and AWS_CLOUDHSM Key store creation:

```terraform
# Pre-requisites for EXTERNAL_KEY_STORE and AWS_CLOUDHSM Key store - AWS connection, AWS KMS
# Create an AWS connection
resource "ciphertrust_aws_connection" "aws-connection" {
  name = "aws_connection_name"
  access_key_id     = "access-key-id"
  secret_access_key = "secret-access-key"
}
output "aws_connection_id" {
  value = ciphertrust_aws_connection.aws-connection.id
}

# Get the AWS account details
data "ciphertrust_aws_account_details" "account_details" {
  aws_connection = ciphertrust_aws_connection.aws-connection.id
}

# Create a kms
resource "ciphertrust_aws_kms" "kms" {
  depends_on = [
    ciphertrust_aws_connection.aws-connection,
  ]
  account_id     = data.ciphertrust_aws_account_details.account_details.account_id
  aws_connection = ciphertrust_aws_connection.aws-connection.id
  name           = "kms-name"
  regions        = data.ciphertrust_aws_account_details.account_details.regions
}

# Create an AES CipherTrust key for creating EXTERNAL_KEY_STORE with CM as key source
# key should be unexportable, undeletable, symmetric AES 256 key
resource "ciphertrust_cm_key" "cm_aes_key" {
  name      = "aes-key-name"
  algorithm = "AES"
  usage_mask = 60
  unexportable = true
  undeletable = true
}
output "cm_aes_key" {
  value = ciphertrust_cm_key.cm_aes_key
}

# Create unlinked external custom keystore with CM as key source; with xks proxy connectivity as PUBLIC_ENDPOINT
resource "ciphertrust_aws_custom_keystore" "unlinked_xks_custom_keystore_for_cm_as_source" {
  depends_on = [
    ciphertrust_aws_kms.kms,
    ciphertrust_cm_key.cm_aes_key,
  ]
  name = "unlinked-xks-demo-1-for-cm-as-source"
  region = "us-west-1"
  kms    = ciphertrust_aws_kms.kms.name
  linked_state = false
  connect_disconnect_keystore = "DISCONNECT_KEYSTORE"
  local_hosted_params {
    blocked = false
    health_check_key_id = ciphertrust_cm_key.cm_aes_key.id
    max_credentials = 8
    source_key_tier = "local"
  }
  aws_param {
    xks_proxy_uri_endpoint = "https://demo-xksproxy.thalescpl.io"
    xks_proxy_connectivity = "PUBLIC_ENDPOINT"
    custom_key_store_type = "EXTERNAL_KEY_STORE"
  }
}

output "unlinked_xks_custom_keystore_for_cm_as_source" {
  value = ciphertrust_aws_custom_keystore.unlinked_xks_custom_keystore_for_cm_as_source
}

# Create linked external custom keystore with CM as key source; with xks proxy connectivity as PUBLIC_ENDPOINT
resource "ciphertrust_aws_custom_keystore" "linked_xks_custom_keystore_for_cm_as_source" {
  depends_on = [
    ciphertrust_aws_kms.kms,
    ciphertrust_cm_key.cm_aes_key,
  ]
  name = "linked-xks-demo-1-for-cm-as-source"
  region = "us-west-1"
  kms    = ciphertrust_aws_kms.kms.name
  linked_state = true
  connect_disconnect_keystore = "DISCONNECT_KEYSTORE"
  local_hosted_params {
    blocked = false
    health_check_key_id = ciphertrust_cm_key.cm_aes_key.id
    max_credentials = 8
    source_key_tier = "local"
  }
  aws_param {
    xks_proxy_uri_endpoint = "https://demo-xksproxy.thalescpl.io"
    xks_proxy_connectivity = "PUBLIC_ENDPOINT"
    custom_key_store_type = "EXTERNAL_KEY_STORE"
  }
}

output "linked_xks_custom_keystore_for_cm_as_source" {
  value = ciphertrust_aws_custom_keystore.linked_xks_custom_keystore_for_cm_as_source
}

# Create Luna Connection, Luna HSM server, Luna Symmetric key for Luna as key source
# Create a hsm network server
resource "ciphertrust_hsm_server" "hsm_server" {
  hostname        = "hsm-ip"
  hsm_certificate = "/path/to/hsm_server_cert.pem"
}

# Create a Luna hsm connection
# is_ha_enabled must be true for more than one partition
resource "ciphertrust_hsm_connection" "hsm_connection" {
  depends_on = [
    ciphertrust_hsm_server.hsm_server,
  ]
  hostname  = "hsm-ip"
  server_id = ciphertrust_hsm_server.hsm_server.id
  name      = "luna-hsm-connection"
  partitions {
    partition_label = "partition-label"
    serial_number   = "serial-number"
  }
  partition_password = "partition-password"
  is_ha_enabled      = false
}
output "hsm_connection_id" {
  value = ciphertrust_hsm_connection.hsm_connection.id
}

# Add a partition to connection
resource "ciphertrust_hsm_partition" "hsm_partition" {
  depends_on = [
    ciphertrust_hsm_connection.hsm_connection,
  ]
  hsm_connection = ciphertrust_hsm_connection.hsm_connection.id
}
output "hsm_partition" {
  value = ciphertrust_hsm_partition.hsm_partition
}

# Create an Symmetric AES-256 Luna HSM key for creating EXTERNAL_KEY_STORE with Luna as key source
resource "ciphertrust_hsm_key" "hsm_aes_key" {
  depends_on = [
    ciphertrust_hsm_partition.hsm_partition,
  ]
  attributes = ["CKA_ENCRYPT", "CKA_DECRYPT", "CKA_WRAP", "CKA_UNWRAP"]
  label        = "key-name"
  mechanism    = "CKM_AES_KEY_GEN"
  partition_id = ciphertrust_hsm_partition.hsm_partition.id
  key_size     = 256
  hyok_key     = true
}

output "hsm_aes_key" {
  value = ciphertrust_hsm_key.hsm_aes_key
}

# Create linked external custom keystore with luna as key source; with xks proxy connectivity as PUBLIC_ENDPOINT
resource "ciphertrust_aws_custom_keystore" "linked_xks_custom_keystore_for_luna_as_source" {
  depends_on = [
    ciphertrust_aws_kms.kms,
    ciphertrust_hsm_partition.hsm_partition,
    ciphertrust_hsm_key.hsm_aes_key,
  ]
  name = "linked-xks-demo-1-for-luna-as-source"
  region = "us-west-1"
  kms    = ciphertrust_aws_kms.kms.name
  linked_state = true
  connect_disconnect_keystore = "DISCONNECT_KEYSTORE"
  local_hosted_params {
    blocked = false
    health_check_key_id = ciphertrust_hsm_key.hsm_aes_key.id
    max_credentials = 8
    source_key_tier = "hsm-luna"
    partition_id = ciphertrust_hsm_partition.hsm_partition.id
  }
  aws_param {
    xks_proxy_uri_endpoint = "https://demo-xksproxy.thalescpl.io"
    xks_proxy_connectivity = "PUBLIC_ENDPOINT"
    custom_key_store_type = "EXTERNAL_KEY_STORE"
  }
}

output "linked_xks_custom_keystore_for_luna_as_source" {
  value = ciphertrust_aws_custom_keystore.linked_xks_custom_keystore_for_luna_as_source
}

## Create cloudHSM keystore
resource "ciphertrust_aws_custom_keystore" "cloudhsm_custom_keystore" {
  depends_on = [
    ciphertrust_aws_kms.kms,
  ]
  name         = "cloudhsm-keystore-demo-1"
  region       = "us-west-1"
  kms          = ciphertrust_aws_kms.kms.name
  connect_disconnect_keystore = "DISCONNECT_KEYSTORE"
  aws_param {
    custom_key_store_type       = "AWS_CLOUDHSM"
    cloud_hsm_cluster_id        = "cluster-pxkcyeoqij"
    key_store_password          = "keystore-password"
    trust_anchor_certificate    = <<-EOT
	                 -----BEGIN CERTIFICATE-----
	                 MIIDhzCCAm+gAwIBAgIUHdJu4algAFs22h87meBhd9Qe4eMoDQYJKoZIhvcNAQEL
	                 BQAwUzELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMRAwDgYQVQQHDAdTYW5Kb3Nl
	                 MQ8wDQYDVQQKDAZUaGFsZXMxFDASBgNVBAsMC0VuZ2luZWVyaW5nMB4XDTIyMDYy
	                 MzA2NTgwOFoXDTMyMDYyMjA2NTgwOFowUzELMAkGA1UEBhMCVVMxCzAJBgNVBAgM
	                 AkNBMRAwDgYDVQQHDAdTYW5Kb3NlMQ8wDQYDVQQKDAZUaEFsZXMxFDASBgNVBAsM
	                 C0VtZ2lvZWVyaW5nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvi0o
	                 wtYFziFkbhtH0X0+0fhvcGLJ4SYTOU50ZGa7GlfsKC4i5vGxXFEJ1QwJ+WmkyXwo
	                 RCWaXQbFkFIxlDDIgOe64Z8FRiqdRGXPAYXvJC5pM015kOGtuMrT759Ifbux81Ng
	                 ULlUbz7uLGxut+IbLXIG+/lkDI8OtYNLtU5hbTG/QrTieFg7ZQ/IKKbmCKB3m3cv
	                 l0MzSMZQXMgNmsbb9SASTgSgaBdAF99sp3B78jHFDqikZHvrxjPBRqi/OsSBefmV
	                 LymMhPBVcF9FWJgL+YpxDjKP4ieo8rqWK9xEDnu6VmVx0guQ40uM4ycaDljBueW6
	                 J9FqXFp63FGrGKu2vwIDBQABo1MwUTAdBgMVHQ4EFgQUi/RAIOrEPaUm9T6P+Ju3
	                 qTKpf90wHwYDVR0jBBgwFoAUi/RAIOrEPaUm9T6P+Ju3qTKpf90wDwYDVR0TAQH/
	                 BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAfhC8EghStmPq770Edt6lfoEC6pIO
	                 UCMoiwnX9KL7WdKPx7auyJmxj3+MbYqMSzilXPA57J1WE6BhT3JOT4nPsO/IpFv2
	                 fbpUVW9ypwrRQE1S1v6BjvQd5J49c3ZDfH634jCwGwxcBY2gSbZorLb03aH7R2uF
	                 31jlyotNaUd3eWjo11jwVt9ZhpcxbaiK98Q6UcUro0Ok2BaQdZZthnuMMnwK8iO2
	                 w3XiEJU3uaUbs1jC6x2Q/RQ28cdAl1tse9/isLeH9yqIEuzFWBHEX5OmpcrW7qcv
	                 SWLFSofuUkHD1GuN8f4ipAzQ0Fn9Y2C463Q3DCzolhRmJrfXVgM6XLRnHg==
	                 -----END CERTIFICATE-----
	               EOT
  }
}

data "ciphertrust_aws_custom_keystore" "cloudhsm_custom_keystore_data_source" {
  depends_on = [
    ciphertrust_aws_custom_keystore.cloudhsm_custom_keystore,
  ]
  id = ciphertrust_aws_custom_keystore.cloudhsm_custom_keystore.id
}

output "cloudhsm_custom_keystore" {
  value = data.ciphertrust_aws_custom_keystore.cloudhsm_custom_keystore_data_source
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `kms` (String) Name or id for the KMS in which custom keystore belongs.
- `name` (String) (Updateable) Unique name for the custom keystore.
- `region` (String) Region in which to create AWS custom keystore.

### Optional

- `aws_param` (Block List) Parameters related to AWS interaction with a custom key store. (see [below for nested schema](#nestedblock--aws_param))
- `connect_disconnect_keystore` (String) Desired state of custom keystore - CONNECT_KEYSTORE, DISCONNECT_KEYSTORE.
- `linked_state` (Boolean) Parameter to indicate if custom keystore is linked with AWS.
- `local_hosted_params` (Block List) Parameters for a custom key store that is locally hosted. (see [below for nested schema](#nestedblock--local_hosted_params))
- `timeouts` (Block, Optional) (see [below for nested schema](#nestedblock--timeouts))

### Read-Only

- `access_key_id` (String) Access key id of credential of AWS custom keystore of type EXTERNAL_KEYSTORE.
- `cloud_name` (String) Name of the cloud.
- `created_at` (String) Date the custom keystore was created.
- `credential_version` (Number) Credential Version of the AWS custom keystore.
- `id` (String) Custom keystore ID.
- `kms_id` (String) ID for the KMS in which custom keystore belongs.
- `secret_access_key` (String) Secret access key of credential of AWS custom keystore of type EXTERNAL_KEYSTORE.
- `type` (String) Location of the AWS custom keystore - LOCAL, REMOTE, CloudHSM.
- `updated_at` (String) Date the custom keystore was last updated.

<a id="nestedblock--aws_param"></a>
### Nested Schema for `aws_param`

Required:

- `custom_key_store_type` (String) AWS XKS custom keystore type.

Optional:

- `cloud_hsm_cluster_id` (String) (Updateable) CloudHSM cluster ID for AWS custom keystore of type AWS_CLOUDHSM. Required during create operation for AWS custom keystore of type AWS_CLOUDHSM.
- `key_store_password` (String) (Updateable) CloudHSM kmsuser Crypto User (CU) password or AWS custom keystore of type AWS_CLOUDHSM. Required during create operation for AWS custom keystore of type AWS_CLOUDHSM.
- `trust_anchor_certificate` (String) Trust anchor certificate for AWS custom keystore of type AWS_CLOUDHSM. Required during create operation for AWS custom keystore of type AWS_CLOUDHSM.
- `xks_proxy_connectivity` (String) (Updateable) AWS XKS connectivity type. Applicable for AWS custom keystore of type EXTERNAL_KEYSTORE. Default is EXTERNAL_KEY_STORE.
- `xks_proxy_uri_endpoint` (String) (Updateable) AWS URI endpoint for custom keystore. Applicable for AWS custom keystore of type EXTERNAL_KEYSTORE with xks_proxy_connectivity of PUBLIC_ENDPOINT.
- `xks_proxy_vpc_endpoint_service_name` (String) (Updateable) VPC endpoint service name. Applicable for AWS custom keystore of type EXTERNAL_KEYSTORE with xks_proxy_connectivity of VPC_ENDPOINT_SERVICE.

Read-Only:

- `connection_state` (String) Connection state of custom keystore in AWS - CONNECTING, CONNECTED, DISCONNECTING, DISCONNECTED, FAILED.
- `custom_key_store_id` (String) Custom keystore ID in AWS.
- `custom_key_store_name` (String) Name of the custom keystore in AWS.
- `xks_proxy_uri_path` (String) URI path of XKS custom keystore in AWS. Applicable for AWS custom keystore of type EXTERNAL_KEYSTORE.


<a id="nestedblock--local_hosted_params"></a>
### Nested Schema for `local_hosted_params`

Optional:

- `blocked` (Boolean) Parameter to indicate if custom keystore is blocked for any data plane operation.
- `health_check_key_id` (String) (Updateable) Health check key ID for checking health of AWS custom keystore. Required parameter only for AWS custom keystore of type EXTERNAL_KEYSTORE. Need to be ID of key based on chosen key source.
- `max_credentials` (Number) Parameter to indicate max count of credentials to be supported for custom keystore. Required parameter only for AWS custom keystore of type EXTERNAL_KEYSTORE.
- `partition_id` (String) Partition ID for the Luna HSM used as source for creating AWS XKS key. Required parameter only for AWS custom keystore of type EXTERNAL_KEYSTORE.
- `source_key_tier` (String) Source key tier for AWS custom keystore - hsm-luna or local. Required parameter only for AWS custom keystore of type EXTERNAL_KEYSTORE.

Read-Only:

- `health_check_ciphertext` (String) Ciphertext of Health check key ID for checking health of AWS custom keystore.
- `linked_state` (Boolean) Parameter to indicate if custom keystore is linked with AWS.
- `partition_label` (String) Partition label for the Luna HSM used as source for creating AWS XKS key.
- `source_container_id` (String) ID of the Source container used for keys in a AWS custom keystore of type EXTERNAL_KEYSTORE.
- `source_container_type` (String) Type of the Source container used for keys in a AWS custom keystore of type EXTERNAL_KEYSTORE.


<a id="nestedblock--timeouts"></a>
### Nested Schema for `timeouts`

Optional:

- `create` (String)


